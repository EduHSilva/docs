---
title: E-mail
description: Documentação do módulo de e-mail.
navigation:
  icon: i-lucide-mail
seo:
  description: Documentação técnica do módulo de e-mail, focado no consumo de eventos de mensageria para envio de comunicações transacionais.
---

::caution
Este módulo não expõe rotas HTTP. Sua operação é baseada na reação a eventos publicados em um sistema de mensageria, o que o torna um serviço de backend desacoplado.
::

## Objetivo

O principal objetivo do módulo de **e-mail** é consumir mensagens de uma fila de eventos e orquestrar o envio de diversas formas de comunicação. Ele atua como um serviço centralizado para:

- **E-mails Transacionais:** Envio de e-mails essenciais para a operação do sistema, como redefinição de senha e faturas.
- **Notificações:** Comunicações sobre atividades relevantes na conta do usuário.
- **Confirmações de Cadastro:** E-mails para verificação de endereço e ativação de novas contas.

## Como Funciona

O módulo opera em um fluxo assíncrono, desacoplado dos serviços que originam as comunicações. O diagrama abaixo ilustra a arquitetura:

![Diagrama de Mensagens](email-diagram.png)

1.  Um **Produtor** (outro microsserviço, como o de usuários) publica um evento em uma fila específica.
2.  O **Consumidor** (este módulo) recebe o evento da fila.
3.  Com base no tipo de evento, o módulo seleciona o template de e-mail apropriado.
4.  O e-mail é processado e enviado através de um provedor de e-mail configurado.

## Eventos Consumidos

O módulo está inscrito para consumir eventos específicos. A seguir, um exemplo de evento que ele processa.

### `USER_CREATED`

Este evento é disparado quando um novo usuário se cadastra na plataforma e necessita receber um e-mail para confirmar sua conta.

- **Fila de Origem:** `email.queue`

- **Payload Esperado:**
  ```json
  {
    "type": "USER_CREATED",
    "data": {
      "userId": "uuid",
      "email": "user@email.com",
      "username": "User Name"
    }
  }
  ```

## Como Publicar Mensagens

Para que o módulo de e-mail envie uma comunicação, um microsserviço produtor deve publicar uma mensagem na fila correta. Abaixo, um exemplo de como fazer isso em Java.

### Exemplo em Java (Produtor)

```java
// Cria o evento com o tipo e os dados necessários
EmailEvent event = new EmailEvent(
  "USER_CREATED",
  Map.of(
    "userId", user.getId(),
    "email", user.getEmail(),
    "username", user.getUsername()
  )
);

// Publica o evento na fila designada para e-mails
messageProducer.publish("email.queue", event);
```

## Regras de Negócio

#### RN1: Validação de Mensagens
Qualquer mensagem recebida que não siga o formato esperado ou contenha dados inválidos será descartada para evitar processamento incorreto.

#### RN2: Idempotência
O envio de e-mails é idempotente, controlado pela combinação do `type` do evento e do `userId`. Isso garante que, mesmo que um evento seja consumido mais de uma vez, o e-mail correspondente será enviado apenas uma vez.

#### RN3: Tratamento de Falhas Temporárias
Em caso de falhas transitórias no envio (ex: instabilidade no provedor de e-mail), a mensagem será reenfileirada para uma nova tentativa de processamento após um intervalo.

#### RN4: Tratamento de Falhas Definitivas
Se uma falha for considerada definitiva (ex: endereço de e-mail inválido), a mensagem será movida para uma Dead Letter Queue (DLQ) para análise manual, liberando a fila principal.

## Observações

- **Independência de HTTP:** O módulo é totalmente desacoplado de interações síncronas via HTTP, operando exclusivamente com base em eventos.
- **Autonomia:** Pode ser implantado e escalado de forma independente dos outros microsserviços da plataforma.
- **Versionamento de Templates:** Os templates de e-mail (HTML/texto) são versionados junto com o código-fonte do módulo, garantindo consistência entre a lógica e o conteúdo.
- **Flexibilidade de Provedor:** O provedor de e-mail (ex: SendGrid, AWS SES) é uma dependência injetada, permitindo que seja substituído sem causar impacto nos serviços produtores de eventos.
